# é£æ§æ¨¡å—

æå‡ç³»ç»Ÿæ•´ä½“çš„å®‰å…¨æ€§ï¼Œ ä¸»è¦çš„ç›®æ ‡æ˜¯é˜²æ­¢ç›—å¸ã€æ¬ºè¯ˆã€æ´—é’±ä¸ä»¥åŠå†…éƒ¨ä½œæ¶ã€‚è€Œä¸”éœ€è¦åœ¨å°½é‡ä¸ç ´åç”¨æˆ·ä½“éªŒä¸‹æ‹¦æˆªé«˜é£é™©è¡Œä¸ºã€‚

## è®¾è®¡æ›´æ–°ï¼Œ

æˆ‘ä»¬å½“å‰çš„è®¾è®¡ä¸Šï¼Œå…¶å®æ˜¯**å­˜åœ¨ä¸€äº›å®‰å…¨é£é™©çš„**ï¼šä¾‹å¦‚ wallet å’Œ scan æ¨¡å—éƒ½ç›´æ¥è¯»å†™æ•°æ®åº“ï¼Œç¼ºä¹ç»Ÿä¸€æƒé™æ§åˆ¶ï¼Œå¾ˆå¯èƒ½å‡ºç°å¼€å‘äººå‘˜å¯ä»¥ç»•è¿‡ä¸šåŠ¡é€»è¾‘ç›´æ¥ä¿®æ”¹æ•æ„Ÿæ•°æ®ã€‚

æˆ‘ä»¬å¯ä»¥è€ƒè™‘æ·»åŠ ä¸€ä¸ªæ•°æ®åº“ç½‘å…³ï¼Œç½‘å…³å•ç‹¬éƒ¨ç½²ï¼Œç»å…è®¸å†…ç½‘æœåŠ¡è®¿é—®ã€‚
å¹¶ä¸”å¯¹æ•°æ®åº“è¯»å†™å®‰æ’ä¸åŒçš„è®¿é—®æƒé™ï¼š



![æ•°æ®åº“ç½‘å…³](https://img.learnblockchain.cn/pics/20250930163609.png)

ç­¾åæœºæ•°æ®åº“ä¿æŒä¸å˜ï¼Œ ç¡®ä¿ç§é’¥åªå­˜åœ¨è‡ªå·±çš„æœ¬æœºï¼Œå¤–éƒ¨ä¸èƒ½è®¿é—®ï¼Œä¸šåŠ¡å±‚æ•°æ®åº“æ ¹æ®è¯»å†™æƒé™ä¸åŒï¼Œåšä¸åŒçš„æ§åˆ¶ï¼š

1. 

Wallet æ¨¡å—å’Œ scan æ¨¡å—



è¯»æ“ä½œï¼š 

- Level 1: è¯»æ“ä½œï¼ˆæ¨¡å—èº«ä»½éªŒè¯ï¼‰
- Level 2: å†™æ“ä½œï¼ˆæ¨¡å—ç­¾åï¼‰, block è¡¨ã€Nonce è¡¨ 
- Level 3: æ•æ„Ÿæ“ä½œï¼ˆä¸šåŠ¡ç­¾å + é£æ§è¯„ä¼°ï¼‰ æµæ°´è¡¨


æç°æ“ä½œä¿®æ”¹ä¸€ä¸‹ï¼Œ ä¿®æ”¹ä¸ºï¼Œ é€šè¿‡é£æ§çš„æç°è¯·æ±‚ï¼Œ æ¶ˆæ¯é˜Ÿåˆ—


å­˜æ¬¾ï¼š 
scan(å†™ credits )  
é£æ§ç»™å‡ºæ“ä½œå»ºè®®ï¼Œå¹¶ç­¾åï¼Œ ä¸šåŠ¡å±‚å†æ¬¡ç­¾å

UUID ï¼Œ é˜²æ­¢ç­¾åé‡æ”¾



å„æ¨¡å—èŒè´£æ¸…æ™°åˆ†ç¦»ï¼Œ





  1. æƒé™ç®¡ç†:



**Level 1 - è¯»æ“ä½œ**
- æƒé™è¦æ±‚ï¼šæ¨¡å—èº«ä»½éªŒè¯
- é€‚ç”¨æ“ä½œï¼šæŸ¥è¯¢ç”¨æˆ·ä½™é¢ã€é’±åŒ…ä¿¡æ¯ã€äº¤æ˜“è®°å½•ç­‰
- ç­¾åè¦æ±‚ï¼šæ¨¡å—èº«ä»½Token
- é€‚ç”¨æ¨¡å—ï¼šWalletã€Scan

**Level 2 - ä¸€èˆ¬å†™æ“ä½œ**
- æƒé™è¦æ±‚ï¼šä¸šåŠ¡æ¨¡å—ç­¾å
- é€‚ç”¨æ“ä½œï¼šåŒºå—é“¾æ‰«ææ•°æ®å½•å…¥ã€é’±åŒ…çŠ¶æ€æ›´æ–°ç­‰
- ç­¾åè¦æ±‚ï¼šä¸šåŠ¡æ¨¡å—ç­¾å
- é€‚ç”¨æ¨¡å—ï¼šScanï¼ˆå……å€¼æ£€æµ‹ï¼‰ã€Walletï¼ˆéæ•æ„Ÿæ›´æ–°ï¼‰

**Level 3 - æ•æ„Ÿæ“ä½œ**
- æƒé™è¦æ±‚ï¼šä¸šåŠ¡ + é£æ§åŒé‡ç­¾å
- é€‚ç”¨æ“ä½œï¼šç”¨æˆ·ä½™é¢å˜æ›´ã€æç°å¤„ç†ã€çƒ­é’±åŒ…æ“ä½œ
- ç­¾åè¦æ±‚ï¼šä¸šåŠ¡ç­¾å + é£æ§ç­¾å
- é€‚ç”¨æ¨¡å—ï¼šWalletï¼ˆæç°ã€ä½™é¢è°ƒæ•´ï¼‰

- æ— æ³•æœ‰æ•ˆé˜²èŒƒå†…éƒ¨ä½œæ¶è¡Œä¸º

## å¤šé‡æ ¡éªŒ

- æ•æ„Ÿæ“ä½œï¼ˆå¦‚æç°ï¼‰ç¼ºä¹æœ‰æ•ˆçš„å¤šé‡éªŒè¯


ä¿è¯å¯å®¡è®¡ã€å¯å›æº¯ã€å¯å“åº”ã€å¹¶æ»¡è¶³ç›‘ç®¡åˆè§„ã€‚


 æƒé™åˆ†çº§: è¯»æ“ä½œã€å†™æ“ä½œã€æ•æ„Ÿæ“ä½œçš„ä¸‰çº§æƒé™ç®¡ç†


ï¼ˆæ—¶é—´æˆ³éªŒè¯ï¼‰

RS256 ä¸ Ed25519 ç­¾åéªŒç­¾



-   3. é£æ§ç³»ç»Ÿ:
    - å¤§é¢æç°è‡ªåŠ¨æ£€æµ‹
    - é¢‘ç¹æ“ä½œæ¨¡å¼è¯†åˆ«
    - å¯é…ç½®é£æ§è§„åˆ™
    - è‡ªåŠ¨/äººå·¥å®¡æ‰¹å†³ç­–


æœ‰æ•ˆé˜²æ­¢å†…éƒ¨ä½œæ¶å¹¶æä¾›å®Œæ•´çš„æ“ä½œå®¡è®¡



ğŸ¯ æ–°æ¶æ„è®¾è®¡

  æ ¸å¿ƒæ€è·¯ï¼šé£æ§å‰ç½® + åŒç­¾åæœºåˆ¶

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ wallet  â”‚    â”‚  scan   â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚              â”‚
       â”‚  â‘ è¯·æ±‚é£æ§è¯„ä¼°
       â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚      â”‚       â”‚
       â–¼      â–¼       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  risk_control       â”‚ â† ä¸ä¸šåŠ¡å±‚åŒçº§
  â”‚  (é£æ§æœåŠ¡)         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ â‘¡è¿”å›é£æ§ç­¾å
            â”‚
       â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚         â”‚
       â–¼         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ wallet  â”‚ â”‚  scan   â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚            â”‚
       â”‚ â‘¢å¸¦åŒç­¾åè¯·æ±‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¤
       â”‚        â”‚   â”‚
       â–¼        â–¼   â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    db_gateway       â”‚ â† éªŒè¯åŒç­¾å
  â”‚  (Database API)     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ä¸šåŠ¡æ•°æ®åº“â”‚ â† æ‰€æœ‰æœåŠ¡å…±äº«åŒä¸€ä¸ªæ•°æ®åº“
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  âœ… è¿™ç§è®¾è®¡çš„ä¼˜åŠ¿

  1. å®‰å…¨æ€§æ›´é«˜

  - åŒç­¾åéªŒè¯ï¼šæ•æ„Ÿæ“ä½œå¿…é¡»åŒæ—¶æœ‰ business_signature + risk_control_signature
  - èŒè´£åˆ†ç¦»ï¼šå³ä½¿ä¸šåŠ¡ç³»ç»Ÿè¢«æ”»ç ´ï¼Œæ²¡æœ‰é£æ§ç­¾åä¹Ÿæ— æ³•æ‰§è¡Œæ•æ„Ÿæ“ä½œ
  - é£æ§å‰ç½®ï¼šåœ¨æ•°æ®å†™å…¥å‰å°±è¿›è¡Œé£æ§æ£€æŸ¥ï¼Œé¿å…è„æ•°æ®

  2. æ€§èƒ½æ›´å¥½

  - å‡å°‘æ•°æ®ä¼ è¾“ï¼šrisk_control ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œå¯ä»¥æŸ¥è¯¢å†å²æ•°æ®åšæ›´ç²¾å‡†çš„é£æ§
  - æ— éœ€æ•°æ®åŒæ­¥ï¼šå…±äº«æ•°æ®åº“ï¼Œæ— éœ€ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§

  3. æ¶æ„æ›´æ¸…æ™°

  - æ˜ç¡®çš„è°ƒç”¨é“¾ï¼šä¸šåŠ¡å±‚ â†’ é£æ§å±‚ â†’ æ•°æ®å±‚
  - èŒè´£æ˜ç¡®ï¼š
    - wallet/scanï¼šä¸šåŠ¡é€»è¾‘ + ä¸šåŠ¡ç­¾å
    - risk_controlï¼šé£æ§è¯„ä¼° + é£æ§ç­¾å
    - db_gatewayï¼šæ•°æ®æ“ä½œ + åŒç­¾åéªŒè¯

  4. çµæ´»æ€§å¼º

  - å¯é€‰é£æ§ï¼šread/write æ“ä½œå¯ä»¥ä¸éœ€è¦é£æ§ç­¾åï¼Œåªæœ‰ sensitive æ“ä½œéœ€è¦
  - é£æ§å‡çº§ï¼šå¯ä»¥ç‹¬ç«‹å‡çº§é£æ§è§„åˆ™ï¼Œä¸å½±å“ä¸šåŠ¡ç³»ç»Ÿ
  - å®¡è®¡å®Œæ•´ï¼šæ‰€æœ‰æ•æ„Ÿæ“ä½œéƒ½æœ‰å®Œæ•´çš„å®¡æ‰¹è®°å½•

  ---
  ğŸ“Š æ•°æ®åº“è®¾è®¡ï¼ˆå…±äº«æ•°æ®åº“ï¼‰

  åœ¨ç°æœ‰çš„ wallet.db ä¸­æ·»åŠ é£æ§ç›¸å…³è¡¨

  1. é£æ§è§„åˆ™è¡¨ (risk_rules)

  CREATE TABLE risk_rules (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    table_name TEXT NOT NULL,          -- withdraws, credits, etc.
    rule_type TEXT NOT NULL,           -- amount_threshold, frequency, blacklist, user_behavior
    conditions TEXT NOT NULL,          -- JSON: è§„åˆ™æ¡ä»¶
    risk_weight INTEGER NOT NULL,      -- é£é™©æƒé‡ 0-100
    enabled INTEGER DEFAULT 1,
    priority INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );

  CREATE INDEX idx_risk_rules_table ON risk_rules(table_name);
  CREATE INDEX idx_risk_rules_enabled ON risk_rules(enabled);

  2. é£æ§è¯„ä¼°è®°å½•è¡¨ (risk_assessments)

  CREATE TABLE risk_assessments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    operation_id TEXT UNIQUE NOT NULL,     -- æ“ä½œID (UUID)
    module TEXT NOT NULL,                  -- wallet/scan
    table_name TEXT NOT NULL,
    action TEXT NOT NULL,
    user_id INTEGER,                       -- å…³è”ç”¨æˆ·
    operation_data TEXT,                   -- JSON: æ“ä½œæ•°æ®æ‘˜è¦
    risk_score INTEGER NOT NULL,
    risk_level TEXT NOT NULL,              -- low/medium/high
    decision TEXT NOT NULL,                -- auto_approve/manual_review/deny
    triggered_rules TEXT,                  -- JSON: è§¦å‘çš„è§„åˆ™IDæ•°ç»„
    reasons TEXT,                          -- JSON: é£é™©åŸå› æ•°ç»„
    required_approvals INTEGER DEFAULT 0,
    current_approvals INTEGER DEFAULT 0,
    approval_status TEXT DEFAULT 'pending',-- pending/approved/rejected/expired
    risk_signature TEXT,                   -- é£æ§ç­¾å
    expires_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
  );

  CREATE INDEX idx_risk_assessments_operation ON risk_assessments(operation_id);
  CREATE INDEX idx_risk_assessments_user ON risk_assessments(user_id);
  CREATE INDEX idx_risk_assessments_status ON risk_assessments(approval_status);
  CREATE INDEX idx_risk_assessments_decision ON risk_assessments(decision);
  CREATE INDEX idx_risk_assessments_expires ON risk_assessments(expires_at);
  CREATE INDEX idx_risk_assessments_created ON risk_assessments(created_at);

  3. äººå·¥å®¡æ‰¹è®°å½•è¡¨ (risk_approvals)

  CREATE TABLE risk_approvals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    assessment_id INTEGER NOT NULL,
    operation_id TEXT NOT NULL,
    approver_user_id INTEGER NOT NULL,
    approver_username TEXT,
    approved INTEGER NOT NULL,             -- 0=æ‹’ç», 1=æ‰¹å‡†
    comment TEXT,
    ip_address TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (assessment_id) REFERENCES risk_assessments(id),
    FOREIGN KEY (approver_user_id) REFERENCES users(id)
  );

  CREATE INDEX idx_risk_approvals_assessment ON risk_approvals(assessment_id);
  CREATE INDEX idx_risk_approvals_operation ON risk_approvals(operation_id);
  CREATE INDEX idx_risk_approvals_approver ON risk_approvals(approver_user_id);

  4. ç”¨æˆ·é£é™©ç”»åƒè¡¨ (user_risk_profiles)

  CREATE TABLE user_risk_profiles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER UNIQUE NOT NULL,
    total_operations INTEGER DEFAULT 0,        -- æ€»æ“ä½œæ¬¡æ•°
    total_withdraws INTEGER DEFAULT 0,
    total_withdraw_amount TEXT DEFAULT '0',    -- ç´¯è®¡æç°é‡‘é¢ï¼ˆæœ€å°å•ä½ï¼‰
    last_withdraw_at DATETIME,
    withdraw_24h_count INTEGER DEFAULT 0,      -- 24å°æ—¶å†…æç°æ¬¡æ•°
    withdraw_24h_amount TEXT DEFAULT '0',      -- 24å°æ—¶å†…æç°é‡‘é¢
    high_risk_operations INTEGER DEFAULT 0,    -- é«˜é£é™©æ“ä½œæ¬¡æ•°
    denied_operations INTEGER DEFAULT 0,       -- è¢«æ‹’ç»æ¬¡æ•°
    blacklisted INTEGER DEFAULT 0,             -- 0=æ­£å¸¸, 1=é»‘åå•
    whitelist_level INTEGER DEFAULT 0,         -- ç™½åå•çº§åˆ« 0-5
    trust_score INTEGER DEFAULT 50,            -- ä¿¡ä»»åˆ†æ•° 0-100
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
  );

  CREATE INDEX idx_user_risk_profiles_user ON user_risk_profiles(user_id);
  CREATE INDEX idx_user_risk_profiles_blacklist ON user_risk_profiles(blacklisted);
  CREATE INDEX idx_user_risk_profiles_trust ON user_risk_profiles(trust_score);

  5. åœ°å€é£é™©è¡¨ (address_risk_list)

  CREATE TABLE address_risk_list (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    address TEXT UNIQUE NOT NULL,
    chain_type TEXT NOT NULL,              -- evm, btc, solana
    risk_type TEXT NOT NULL,               -- blacklist/whitelist/suspicious/sanctioned
    risk_level TEXT DEFAULT 'medium',      -- low/medium/high
    reason TEXT,
    source TEXT DEFAULT 'manual',          -- manual/auto/chainalysis/ofac
    enabled INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );

  CREATE INDEX idx_address_risk_address ON address_risk_list(address);
  CREATE INDEX idx_address_risk_type ON address_risk_list(risk_type);
  CREATE INDEX idx_address_risk_enabled ON address_risk_list(enabled);

  6. é£æ§æ“ä½œæ—¥å¿—è¡¨ (risk_operation_logs)

  CREATE TABLE risk_operation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    operation_id TEXT NOT NULL,
    assessment_id INTEGER,
    event_type TEXT NOT NULL,              -- assess/approve/reject/execute/expire
    event_data TEXT,                       -- JSON: äº‹ä»¶æ•°æ®
    operator TEXT,                         -- æ“ä½œè€… (system/user_id)
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (assessment_id) REFERENCES risk_assessments(id)
  );

  CREATE INDEX idx_risk_logs_operation ON risk_operation_logs(operation_id);
  CREATE INDEX idx_risk_logs_assessment ON risk_operation_logs(assessment_id);
  CREATE INDEX idx_risk_logs_event ON risk_operation_logs(event_type);
  CREATE INDEX idx_risk_logs_created ON risk_operation_logs(created_at);

  ---
  ğŸ”„ å®Œæ•´æµç¨‹è®¾è®¡

  åœºæ™¯ï¼šç”¨æˆ·æç°ï¼ˆæ•æ„Ÿæ“ä½œï¼‰

  Step 1: ä¸šåŠ¡å±‚å‘èµ·é£æ§è¯„ä¼°è¯·æ±‚

  // wallet/src/services/withdrawService.ts

  async createWithdraw(params: WithdrawParams) {
    // 1. å…ˆè¯·æ±‚é£æ§è¯„ä¼°
    const riskAssessment = await this.requestRiskControl({
      operation_id: uuidv4(),
      operation_type: 'sensitive',
      table: 'withdraws',
      action: 'insert',
      data: {
        user_id: params.userId,
        to_address: params.toAddress,
        amount: params.amount,
        token_id: params.tokenId,
        chain_id: params.chainId
      }
    });

    // 2. æ ¹æ®é£æ§å†³ç­–å¤„ç†
    if (riskAssessment.decision === 'deny') {
      throw new Error(`Operation denied: ${riskAssessment.reasons.join(', ')}`);
    }

    if (riskAssessment.decision === 'manual_review') {
      // ç­‰å¾…äººå·¥å®¡æ‰¹
      return {
        status: 'pending_approval',
        operation_id: riskAssessment.operation_id,
        message: `Requires manual approval: ${riskAssessment.reasons.join(', ')}`,
        expires_at: riskAssessment.expires_at
      };
    }

    // 3. é£æ§é€šè¿‡ï¼Œè·å–é£æ§ç­¾åï¼Œæ‰§è¡Œæ•°æ®åº“æ“ä½œ
    const result = await this.dbGateway.executeWithRiskSignature({
      operation_id: riskAssessment.operation_id,
      operation_type: 'sensitive',
      table: 'withdraws',
      action: 'insert',
      data: params,
      business_signature: this.signer.sign(...),
      risk_control_signature: riskAssessment.risk_signature  // é£æ§ç­¾å
    });

    return result;
  }

  Step 2: risk_control æœåŠ¡å¤„ç†è¯„ä¼°è¯·æ±‚

  // risk_control/src/controllers/assessment.ts

  async evaluate(req: Request, res: Response) {
    const request = req.body;

    // 1. æŸ¥è¯¢ç”¨æˆ·é£é™©ç”»åƒ
    const userProfile = await this.db.getUserRiskProfile(request.data.user_id);

    // 2. æŸ¥è¯¢åœ°å€é£é™©ï¼ˆå¦‚æœæ˜¯æç°ï¼‰
    let addressRisk = null;
    if (request.table === 'withdraws' && request.data.to_address) {
      addressRisk = await this.db.getAddressRisk(request.data.to_address);
    }

    // 3. æŸ¥è¯¢ç”¨æˆ·æœ€è¿‘çš„æ“ä½œé¢‘ç‡
    const recentOps = await this.db.getRecentOperations(
      request.data.user_id,
      request.table,
      24 // 24å°æ—¶å†…
    );

    // 4. åº”ç”¨æ‰€æœ‰é£æ§è§„åˆ™
    const rules = await this.db.getActiveRules(request.table);
    let totalScore = 0;
    const triggeredRules: string[] = [];
    const reasons: string[] = [];

    for (const rule of rules) {
      const result = await this.ruleEvaluator.evaluate(rule, {
        request,
        userProfile,
        addressRisk,
        recentOps
      });

      if (result.triggered) {
        totalScore += rule.risk_weight;
        triggeredRules.push(rule.id);
        reasons.push(result.reason);
      }
    }

    // 5. è®¡ç®—é£é™©ç­‰çº§å’Œå†³ç­–
    const assessment = this.calculateAssessment(totalScore, triggeredRules, reasons);

    // 6. å¦‚æœé€šè¿‡ï¼Œç”Ÿæˆé£æ§ç­¾å
    let riskSignature = null;
    if (assessment.decision === 'auto_approve') {
      riskSignature = this.signer.sign({
        operation_id: request.operation_id,
        decision: assessment.decision,
        risk_score: assessment.risk_score,
        timestamp: Date.now()
      });
    }

    // 7. ä¿å­˜è¯„ä¼°è®°å½•
    await this.db.saveAssessment({
      operation_id: request.operation_id,
      module: request.module,
      table_name: request.table,
      action: request.action,
      user_id: request.data.user_id,
      operation_data: JSON.stringify(request.data),
      risk_score: assessment.risk_score,
      risk_level: assessment.risk_level,
      decision: assessment.decision,
      triggered_rules: JSON.stringify(triggeredRules),
      reasons: JSON.stringify(reasons),
      required_approvals: assessment.required_approvals,
      risk_signature: riskSignature,
      expires_at: assessment.expires_at
    });

    // 8. è®°å½•æ—¥å¿—
    await this.db.logRiskOperation({
      operation_id: request.operation_id,
      event_type: 'assess',
      event_data: JSON.stringify(assessment),
      operator: 'system'
    });

    // 9. æ›´æ–°ç”¨æˆ·é£é™©ç”»åƒ
    await this.db.updateUserRiskProfile(request.data.user_id, {
      total_operations: userProfile.total_operations + 1,
      high_risk_operations: assessment.risk_level === 'high'
        ? userProfile.high_risk_operations + 1
        : userProfile.high_risk_operations
    });

    res.json({
      success: true,
      assessment: {
        ...assessment,
        risk_signature: riskSignature
      }
    });
  }

  Step 3: db_gateway éªŒè¯åŒç­¾å

  // db_gateway/src/middleware/signature.ts

  verifyRiskControlSignature = async (
    req: AuthenticatedRequest,
    res: Response,
    next: NextFunction
  ) => {
    const gatewayRequest = req.gatewayRequest!;

    // åªæœ‰ sensitive æ“ä½œéœ€è¦é£æ§ç­¾å
    if (gatewayRequest.operation_type !== 'sensitive') {
      next();
      return;
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰é£æ§ç­¾å
    if (!gatewayRequest.risk_control_signature) {
      return res.status(403).json({
        success: false,
        error: {
          code: 'MISSING_RISK_SIGNATURE',
          message: 'Sensitive operation requires risk control signature'
        }
      });
    }

    // éªŒè¯é£æ§ç­¾å
    const verifier = new Ed25519Verifier();
    const isValid = verifier.verify(
      {
        operation_id: gatewayRequest.operation_id,
        decision: 'auto_approve',  // åªæœ‰ auto_approve æ‰æœ‰ç­¾å
        timestamp: gatewayRequest.timestamp
      },
      gatewayRequest.risk_control_signature,
      'risk_control'  // ä½¿ç”¨ risk_control çš„å…¬é’¥
    );

    if (!isValid) {
      logger.warn('Invalid risk control signature', {
        operation_id: gatewayRequest.operation_id
      });

      return res.status(403).json({
        success: false,
        error: {
          code: 'INVALID_RISK_SIGNATURE',
          message: 'Risk control signature verification failed'
        }
      });
    }

    logger.info('Risk control signature verified', {
      operation_id: gatewayRequest.operation_id
    });

    next();
  };

  Step 4: äººå·¥å®¡æ‰¹æµç¨‹

  // risk_control/src/controllers/approval.ts

  async approve(req: Request, res: Response) {
    const { operation_id, approver_user_id, approved, comment } = req.body;

    // 1. æŸ¥è¯¢è¯„ä¼°è®°å½•
    const assessment = await this.db.getAssessmentByOperationId(operation_id);

    if (!assessment) {
      return res.status(404).json({
        success: false,
        error: { code: 'NOT_FOUND', message: 'Assessment not found' }
      });
    }

    // 2. æ£€æŸ¥æ˜¯å¦å·²è¿‡æœŸ
    if (new Date(assessment.expires_at) < new Date()) {
      await this.db.updateAssessmentStatus(assessment.id, 'expired');
      return res.status(400).json({
        success: false,
        error: { code: 'EXPIRED', message: 'Assessment has expired' }
      });
    }

    // 3. è®°å½•å®¡æ‰¹
    await this.db.createApproval({
      assessment_id: assessment.id,
      operation_id,
      approver_user_id,
      approver_username: req.user?.username,
      approved: approved ? 1 : 0,
      comment,
      ip_address: req.ip
    });

    // 4. æ›´æ–°å®¡æ‰¹çŠ¶æ€
    const currentApprovals = assessment.current_approvals + (approved ? 1 : 0);
    const approvalStatus = approved
      ? (currentApprovals >= assessment.required_approvals ? 'approved' : 'pending')
      : 'rejected';

    await this.db.updateAssessment(assessment.id, {
      current_approvals: currentApprovals,
      approval_status: approvalStatus
    });

    // 5. å¦‚æœå®¡æ‰¹é€šè¿‡ï¼Œç”Ÿæˆé£æ§ç­¾å
    let riskSignature = null;
    if (approvalStatus === 'approved') {
      riskSignature = this.signer.sign({
        operation_id,
        decision: 'approved',
        risk_score: assessment.risk_score,
        timestamp: Date.now()
      });

      await this.db.updateAssessmentSignature(assessment.id, riskSignature);
    }

    // 6. è®°å½•æ—¥å¿—
    await this.db.logRiskOperation({
      operation_id,
      assessment_id: assessment.id,
      event_type: approved ? 'approve' : 'reject',
      event_data: JSON.stringify({ approver_user_id, comment }),
      operator: `user_${approver_user_id}`
    });

    // 7. æ›´æ–°ç”¨æˆ·é£é™©ç”»åƒ
    if (!approved) {
      await this.db.incrementDeniedOperations(assessment.user_id);
    }

    res.json({
      success: true,
      message: approved ? 'Operation approved' : 'Operation rejected',
      assessment: {
        operation_id,
        approval_status: approvalStatus,
        current_approvals: currentApprovals,
        required_approvals: assessment.required_approvals,
        risk_signature: riskSignature
      }
    });
  }

  ---
  ğŸ”§ API è®¾è®¡

  risk_control æœåŠ¡ API

  1. é£æ§è¯„ä¼° API

  POST /api/risk/evaluate
  X-Signature: <business_signature>  // ä¸šåŠ¡å±‚ç­¾åï¼Œç¡®ä¿è¯·æ±‚æ¥è‡ª wallet/scan

  Request:
  {
    "operation_id": "uuid",
    "operation_type": "sensitive",
    "module": "wallet",
    "table": "withdraws",
    "action": "insert",
    "data": {
      "user_id": 123,
      "to_address": "0xabc...",
      "amount": "50000000000000000000000",
      "token_id": 1,
      "chain_id": 31337
    },
    "timestamp": 1727700000000
  }

  Response (è‡ªåŠ¨é€šè¿‡):
  {
    "success": true,
    "assessment": {
      "operation_id": "uuid",
      "risk_score": 25,
      "risk_level": "low",
      "decision": "auto_approve",
      "reasons": ["Low risk operation"],
      "required_approvals": 0,
      "risk_signature": "é£æ§ç­¾åhexå­—ç¬¦ä¸²"
    }
  }

  Response (éœ€è¦å®¡æ‰¹):
  {
    "success": true,
    "assessment": {
      "operation_id": "uuid",
      "risk_score": 65,
      "risk_level": "medium",
      "decision": "manual_review",
      "reasons": ["Large amount withdrawal: 50000 tokens", "User has 3 withdrawals in last 24h"],
      "required_approvals": 1,
      "expires_at": "2025-10-01T10:00:00Z",
      "risk_signature": null
    }
  }

  Response (æ‹’ç»):
  {
    "success": true,
    "assessment": {
      "operation_id": "uuid",
      "risk_score": 95,
      "risk_level": "high",
      "decision": "deny",
      "reasons": ["Destination address is blacklisted", "User is in blacklist"],
      "required_approvals": 0,
      "risk_signature": null
    }
  }

  2. äººå·¥å®¡æ‰¹ API

  POST /api/risk/approve
  Authorization: Bearer <admin_token>  // éœ€è¦ç®¡ç†å‘˜æƒé™

  Request:
  {
    "operation_id": "uuid",
    "approver_user_id": 999,
    "approved": true,
    "comment": "Verified with user via phone call"
  }

  Response:
  {
    "success": true,
    "message": "Operation approved",
    "assessment": {
      "operation_id": "uuid",
      "approval_status": "approved",
      "current_approvals": 1,
      "required_approvals": 1,
      "risk_signature": "å®¡æ‰¹é€šè¿‡åçš„é£æ§ç­¾å"
    }
  }

  3. æŸ¥è¯¢å¾…å®¡æ‰¹æ“ä½œ

  GET /api/risk/pending?limit=20&offset=0
  Authorization: Bearer <admin_token>

  Response:
  {
    "success": true,
    "data": [
      {
        "id": 123,
        "operation_id": "uuid",
        "module": "wallet",
        "table": "withdraws",
        "action": "insert",
        "user_id": 456,
        "operation_summary": {
          "to_address": "0xabc...",
          "amount": "50000000000000000000000",
          "token_symbol": "ETH"
        },
        "risk_score": 65,
        "risk_level": "medium",
        "decision": "manual_review",
        "reasons": ["Large amount withdrawal: 50000 tokens"],
        "required_approvals": 1,
        "current_approvals": 0,
        "expires_at": "2025-10-01T10:00:00Z",
        "created_at": "2025-09-30T10:00:00Z"
      }
    ],
    "total": 5,
    "limit": 20,
    "offset": 0
  }

  4. æŸ¥è¯¢æ“ä½œé£æ§çŠ¶æ€

  GET /api/risk/status/:operation_id

  Response:
  {
    "success": true,
    "assessment": {
      "operation_id": "uuid",
      "risk_score": 65,
      "risk_level": "medium",
      "decision": "manual_review",
      "approval_status": "pending",
      "current_approvals": 0,
      "required_approvals": 1,
      "expires_at": "2025-10-01T10:00:00Z",
      "approvals": []
    }
  }

  5. è§„åˆ™ç®¡ç† API

  // è·å–æ‰€æœ‰è§„åˆ™
  GET /api/risk/rules

  // åˆ›å»ºè§„åˆ™
  POST /api/risk/rules
  {
    "id": "large_eth_withdraw",
    "name": "Large ETH Withdrawal",
    "description": "ETH withdrawals over 100 ETH",
    "table_name": "withdraws",
    "rule_type": "amount_threshold",
    "conditions": {
      "token_symbol": "ETH",
      "amount": { ">": "100000000000000000000" }
    },
    "risk_weight": 50,
    "enabled": true
  }

  // æ›´æ–°è§„åˆ™
  PUT /api/risk/rules/:id

  // ç¦ç”¨è§„åˆ™
  DELETE /api/risk/rules/:id

  ---
  ğŸ” ç¯å¢ƒå˜é‡é…ç½®

  risk_control/.env

  # æœåŠ¡é…ç½®
  PORT=3004
  NODE_ENV=development

  # æ•°æ®åº“é…ç½®
  DATABASE_PATH=../db_gateway/wallet.db  # å…±äº«ä¸šåŠ¡æ•°æ®åº“

  # ç­¾åå¯†é’¥
  RISK_CONTROL_PRIVATE_KEY=é£æ§æœåŠ¡çš„ç§é’¥hex
  WALLET_PUBLIC_KEY=walletæœåŠ¡çš„å…¬é’¥hex
  SCAN_PUBLIC_KEY=scanæœåŠ¡çš„å…¬é’¥hex

  # é£æ§é…ç½®
  DEFAULT_EXPIRE_HOURS=24
  MAX_RISK_SCORE=100

  wallet/.env

  # æ·»åŠ é£æ§æœåŠ¡åœ°å€
  RISK_CONTROL_URL=http://localhost:3004
  RISK_CONTROL_PUBLIC_KEY=é£æ§æœåŠ¡çš„å…¬é’¥hex

  scan/.env

  # æ·»åŠ é£æ§æœåŠ¡åœ°å€
  RISK_CONTROL_URL=http://localhost:3004
  RISK_CONTROL_PUBLIC_KEY=é£æ§æœåŠ¡çš„å…¬é’¥hex

  db_gateway/.env

  # æ·»åŠ é£æ§æœåŠ¡å…¬é’¥
  RISK_CONTROL_PUBLIC_KEY=é£æ§æœåŠ¡çš„å…¬é’¥hex

  ---
  ğŸ“ å®æ–½æ­¥éª¤

  Phase 1: æ•°æ®åº“å‡†å¤‡

  1. åœ¨ wallet.db ä¸­åˆ›å»ºé£æ§ç›¸å…³çš„6å¼ è¡¨
  2. åˆå§‹åŒ–é»˜è®¤é£æ§è§„åˆ™

  Phase 2: åˆ›å»º risk_control æœåŠ¡

  1. åˆ›å»º risk_control ç›®å½•ç»“æ„
  2. å®ç°é£æ§è¯„ä¼°å¼•æ“
  3. å®ç°è§„åˆ™è¯„ä¼°å™¨
  4. å®ç° API æ¥å£
  5. æ·»åŠ ç­¾åç”ŸæˆåŠŸèƒ½

  Phase 3: ä¿®æ”¹ wallet/scan æœåŠ¡

  1. æ·»åŠ  RiskControlClient ç”¨äºè°ƒç”¨é£æ§ API
  2. åœ¨æ•æ„Ÿæ“ä½œå‰è°ƒç”¨é£æ§è¯„ä¼°
  3. è·å–é£æ§ç­¾ååå†è°ƒç”¨ db_gateway

  Phase 4: ä¿®æ”¹ db_gateway

  1. åœ¨ signature.ts ä¸­æ·»åŠ é£æ§ç­¾åéªŒè¯ä¸­é—´ä»¶
  2. ä¿®æ”¹è·¯ç”±ï¼Œæ•æ„Ÿæ“ä½œéœ€è¦éªŒè¯é£æ§ç­¾å
  3. ç§»é™¤ç°æœ‰çš„ RiskControlService ç›¸å…³ä»£ç 

  Phase 5: æµ‹è¯•

  1. æµ‹è¯•è‡ªåŠ¨é€šè¿‡åœºæ™¯
  2. æµ‹è¯•éœ€è¦å®¡æ‰¹åœºæ™¯
  3. æµ‹è¯•æ‹’ç»åœºæ™¯
  4. æµ‹è¯•äººå·¥å®¡æ‰¹æµç¨‹

  ---
  ğŸ æ€»ç»“

  è¿™ç§è®¾è®¡çš„æ ¸å¿ƒä¼˜åŠ¿

  1. å®‰å…¨éš”ç¦»ï¼šé£æ§æœåŠ¡ç‹¬ç«‹è¿è¡Œï¼Œæœ‰è‡ªå·±çš„å¯†é’¥å¯¹
  2. åŒç­¾åæœºåˆ¶ï¼šæ•æ„Ÿæ“ä½œå¿…é¡»åŒæ—¶æœ‰ä¸šåŠ¡ç­¾åå’Œé£æ§ç­¾å
  3. èŒè´£æ¸…æ™°ï¼š
    - wallet/scanï¼šä¸šåŠ¡é€»è¾‘
    - risk_controlï¼šé£æ§å†³ç­–
    - db_gatewayï¼šæ•°æ®å­˜å‚¨
  4. æ•°æ®å…±äº«ï¼šä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“ï¼Œé£æ§å¯ä»¥æŸ¥è¯¢å®Œæ•´çš„å†å²æ•°æ®
  5. æµç¨‹é€æ˜ï¼šæ‰€æœ‰é£æ§è¯„ä¼°éƒ½æœ‰è®°å½•ï¼Œä¾¿äºå®¡è®¡
  6. çµæ´»æ‰©å±•ï¼šå¯ä»¥éšæ—¶æ·»åŠ æ–°çš„é£æ§è§„åˆ™

  å…³é”®ç‚¹

  - âœ… é£æ§å‰ç½®ï¼šåœ¨å†™å…¥æ•°æ®åº“å‰å°±è¿›è¡Œé£æ§è¯„ä¼°
  - âœ… åŒç­¾åï¼šbusiness_signature + risk_control_signature
  - âœ… å…±äº«æ•°æ®åº“ï¼šé£æ§æœåŠ¡å¯ä»¥ç›´æ¥æŸ¥è¯¢ä¸šåŠ¡æ•°æ®
  - âœ… å®¡æ‰¹æœºåˆ¶ï¼šé«˜é£é™©æ“ä½œéœ€è¦äººå·¥å®¡æ‰¹
  - âœ… å®Œæ•´å®¡è®¡ï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰è®°å½•